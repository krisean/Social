const fs = require('fs');
const path = require('path');

// Map of library IDs to their metadata
const libraries = [
  { id: 'medieval', name: 'Medieval Mayhem', emoji: 'âš”ï¸', description: 'Knights, castles, and medieval chaos for history buffs.', file: 'medievalPrompts.json', sortOrder: 8 },
  { id: 'anime', name: 'Anime Antics', emoji: 'ðŸœ', description: 'Slice-of-life and ridiculous shonen-themed prompts.', file: 'animePrompts.json', sortOrder: 9 },
  { id: 'politics', name: 'Political Roasts', emoji: 'ðŸ›ï¸', description: 'Global politics satire for the politically aware crowd.', file: 'politicsPrompts.json', sortOrder: 10 },
  { id: 'scifi', name: 'Sci-Fi Shenanigans', emoji: 'ðŸš€', description: 'Space stations, aliens, and futuristic fails.', file: 'scifiPrompts.json', sortOrder: 11 },
  { id: 'popculture', name: 'Pop Culture Chaos', emoji: 'â­', description: 'Celebrity drama and entertainment industry roasts.', file: 'popCulturePrompts.json', sortOrder: 12 },
  { id: 'cinema', name: 'Cinema Snark', emoji: 'ðŸŽ¬', description: 'Movie industry humor and film fails.', file: 'cinemaPrompts.json', sortOrder: 13 },
  { id: 'canucks', name: 'Canucks Chaos', emoji: 'ðŸ’', description: 'Vancouver Canucks memes and hockey heartbreak.', file: 'canucksPrompts.json', sortOrder: 14 },
  { id: 'bc', name: 'BC Vibes', emoji: 'ðŸŒ²', description: 'British Columbia culture, housing crisis, and ferry delays.', file: 'bcPrompts.json', sortOrder: 15 },
  { id: 'tech', name: 'Tech & AI Slop', emoji: 'ðŸ’»', description: 'Modern tech fails and AI-generated chaos.', file: 'techPrompts.json', sortOrder: 16 },
  { id: 'internetculture', name: 'Internet Culture', emoji: 'ðŸ“±', description: 'Viral memes, cancel culture, and social media phenomena.', file: 'internetCulturePrompts.json', sortOrder: 17 },
  { id: 'datingapp', name: 'Dating App Disasters', emoji: 'ðŸ’”', description: 'Modern dating fails, ghosting, and profile disasters.', file: 'datingAppPrompts.json', sortOrder: 18 },
  { id: 'remotework', name: 'Remote Work Reality', emoji: 'ðŸ’¼', description: 'Zoom fails, WFH struggles, and work-life boundaries.', file: 'remoteWorkPrompts.json', sortOrder: 19 },
  { id: 'adulting', name: 'Adulting Fails', emoji: 'ðŸŽ“', description: 'Taxes, responsibilities, and pretending to be an adult.', file: 'adultingPrompts.json', sortOrder: 20 },
  { id: 'groupchat', name: 'Group Chat Chaos', emoji: 'ðŸ’¬', description: 'Wrong messages, group dynamics, and chat etiquette.', file: 'groupChatPrompts.json', sortOrder: 21 },
  { id: 'streaming', name: 'Streaming Wars', emoji: 'ðŸ“º', description: 'Too many subscriptions, binge culture, and algorithm fails.', file: 'streamingPrompts.json', sortOrder: 22 },
  { id: 'climateanxiety', name: 'Climate Anxiety', emoji: 'ðŸŒ', description: 'Eco-guilt, greenwashing, and sustainability pressure.', file: 'climateAnxietyPrompts.json', sortOrder: 23 },
  { id: 'fictionalworlds', name: 'Fictional Worlds', emoji: 'ðŸŽ­', description: 'Dark humor about Star Wars, Harry Potter, and more.', file: 'fictionalWorldsPrompts.json', sortOrder: 24 },
];

// Updated libraries
const updatedLibraries = [
  { id: 'classic', file: 'prompts.json' },
  { id: 'basic', file: 'basicprompts.json' },
];

const promptsDir = path.join(__dirname, '../apps/event-platform/src/shared');

function escapeSql(text) {
  return text.replace(/'/g, "''");
}

function generateLibraryInserts() {
  let sql = '-- =============================================================================\n';
  sql += '-- ADD NEW PROMPT LIBRARIES\n';
  sql += '-- =============================================================================\n\n';
  sql += 'INSERT INTO prompt_libraries (id, name, emoji, description, sort_order) VALUES\n';
  
  const values = libraries.map(lib => 
    `  ('${lib.id}', '${escapeSql(lib.name)}', '${lib.emoji}', '${escapeSql(lib.description)}', ${lib.sortOrder})`
  );
  
  sql += values.join(',\n');
  sql += '\nON CONFLICT (id) DO NOTHING;\n\n';
  
  return sql;
}

function generatePromptInserts(libraryId, prompts) {
  let sql = `-- Insert ${libraryId} prompts\n`;
  sql += `INSERT INTO prompts (library_id, text, sort_order) VALUES\n`;
  
  const values = prompts.map((prompt, index) => 
    `  ('${libraryId}', '${escapeSql(prompt)}', ${index + 1})`
  );
  
  sql += values.join(',\n');
  sql += ';\n\n';
  
  return sql;
}

function generateMigration() {
  let sql = '-- Migration to add new prompt libraries and update existing ones\n';
  sql += '-- Date: 2026-01-08\n';
  sql += '-- Generated by generate-prompt-migration.js\n\n';
  
  // Add new libraries
  sql += generateLibraryInserts();
  
  // Add prompts for new libraries
  for (const lib of libraries) {
    const filePath = path.join(promptsDir, lib.file);
    try {
      const prompts = JSON.parse(fs.readFileSync(filePath, 'utf8'));
      sql += `-- =============================================================================\n`;
      sql += `-- ${lib.name.toUpperCase()} PROMPTS\n`;
      sql += `-- =============================================================================\n\n`;
      sql += generatePromptInserts(lib.id, prompts);
    } catch (error) {
      console.error(`Error reading ${lib.file}:`, error.message);
    }
  }
  
  // Update existing libraries
  for (const lib of updatedLibraries) {
    const filePath = path.join(promptsDir, lib.file);
    try {
      const prompts = JSON.parse(fs.readFileSync(filePath, 'utf8'));
      sql += `-- =============================================================================\n`;
      sql += `-- UPDATE EXISTING PROMPT LIBRARY: ${lib.id.toUpperCase()}\n`;
      sql += `-- =============================================================================\n\n`;
      sql += `-- Delete old ${lib.id} prompts\n`;
      sql += `DELETE FROM prompts WHERE library_id = '${lib.id}';\n\n`;
      sql += generatePromptInserts(lib.id, prompts);
    } catch (error) {
      console.error(`Error reading ${lib.file}:`, error.message);
    }
  }
  
  return sql;
}

// Generate and write migration
const migration = generateMigration();
const outputPath = path.join(__dirname, '../supabase/migrations/20260108000000_add_new_prompt_libraries.sql');
fs.writeFileSync(outputPath, migration);
console.log(`âœ… Migration generated: ${outputPath}`);
console.log(`ðŸ“Š Added ${libraries.length} new libraries`);
console.log(`ðŸ”„ Updated ${updatedLibraries.length} existing libraries`);
